<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Budget Tracker</title>
  <link rel="stylesheet" href="budget.css" />

  <!-- PapaParse library to parse CSV data -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <header>
    <h1>Student Budget Tracker</h1>
    <p>Upload your bank statement (CSV) to see your income and expenses.</p>
  </header>

  <main>
    <!--file upload -->
    <section class="upload-section">
      <div class="drop-zone" id="dropZone">
        Drag & drop your CSV here<br>or click to select
        <!--  file input triggered by click on drop zone -->
        <input type="file" id="fileInput" accept=".csv" hidden />
      </div>
      <p class="upload-note">
        Your CSV must have a header on line 7:<br>
        <code>Date,Unique Id,Tran Type,Cheque Number,Payee,Memo,Amount</code>
      </p>
    </section>

    <!--  display the income and expense tables -->
    <section class="table-section">
      <h2>Income <span class="total" id="incomeTotal">($0.00)</span></h2>
      <table id="incomeTable">
        <thead>
          <tr><th>Date</th><th>Description</th><th>Amount</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Expenses <span class="total" id="expenseTotal">($0.00)</span></h2>
      <table id="expensesTable">
        <thead>
          <tr><th>Date</th><th>Description</th><th>Amount</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    // Get references to DOM elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    //  click on drop zone: trigger the hidden file input
    dropZone.addEventListener('click', () => fileInput.click());

    // highlight drop zone when a file is dragged over it
    dropZone.addEventListener('dragover', e => {
      e.preventDefault(); // stop default to allow drop
      dropZone.classList.add('dragover');
    });

    // stop highlight when dragging leaves the drop zone
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    // handling file drop
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0]; // getting first file
      if (file && file.type === 'text/csv') parseAndDisplay(file);
      else alert('Please drop a valid CSV file.');
    });

    // file selection using the file picker
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file && file.type === 'text/csv') parseAndDisplay(file);
      else alert('Please select a valid CSV file.');
    });

    // read and display CSV content
    function parseAndDisplay(file) {
      const reader = new FileReader(); // file reader

      reader.onload = e => {
        // read the file 
        const allLines = e.target.result.split(/\r?\n/); // split lines
        const dataLines = allLines.slice(6).join('\n'); // ignore first 6 lines keeps header as line 7

        // PapaParse to parse the CSV 
        Papa.parse(dataLines, {
          header: true,           // header row 7
          skipEmptyLines: true,   // ignore blank lines
          dynamicTyping: true,    // change strings to numbers
          
          complete: results => {
            // get table bodies
            const incomeBody = document.querySelector('#incomeTable tbody');
            const expenseBody = document.querySelector('#expensesTable tbody');

            // reset totals and table content
            let totalIncome = 0, totalExpense = 0;
            incomeBody.innerHTML = '';
            expenseBody.innerHTML = '';

            // Loop transaction rows
            results.data.forEach(tx => {
              // Skips invalid rows
              if (!tx.Date || !tx.Amount) return;
              const amount = parseFloat(tx.Amount);
              if (isNaN(amount)) return;

              // Create a new row element
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${tx.Date}</td>
                <td>${tx.Memo || tx.Payee || ''}</td>
                <td>$${Math.abs(amount).toFixed(2)}</td>
              `;

              // show as as income or expense
              if (amount >= 0) {
                incomeBody.appendChild(row);
                totalIncome += amount;
              } else {
                expenseBody.appendChild(row);
                totalExpense += amount;
              }
            });

            // add the total display values
            document.getElementById('incomeTotal').textContent =
              `($${totalIncome.toFixed(2)})`;
            document.getElementById('expenseTotal').textContent =
              `($${Math.abs(totalExpense).toFixed(2)})`;
          },

          // error handler
          error: err => {
            console.error('Parsing error:', err);
            alert('Failed to parse CSV.');
          }
        });
      };

      // starts reading the file as text
      reader.readAsText(file);
    }
  </script>
</body>
</html>
